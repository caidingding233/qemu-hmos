首先 我们需要把qemu编译为qemu库 然后呢再把napi啊 啥ndk啊暴露出来 在一个进程里面跑主循环 启动前调用prctl(0x6a6974, 1) 这个是打开jit权限 打不开就用tci 以及检测这台设备支持KVM功能吗 不支持降级 能从Windows官网下载Windows 11 ARM64的英文镜像 或者是Linux阵营的某个发行版 但是app为中文 下载器支持断点续传 最好能挂在实况窗(鸿蒙版灵动岛)上 第一期启动要求你选择系统阵营 比如说Windows 或者是Linux 下完之后 自动创建硬盘文件 可以指定多少gb大 然后呢 启动安装 内置efi的固件 nvme硬盘 user-net和hostfwd 来把远程访问从3389转到127.0.0.1:3390 app可以内置vnc观看 或者是操作安装画面 但是装好之后 用户开始使用 就用freerdp连接到127.0.0.1:3390来操作虚拟机 而且呢 我们有三个页面 一个虚拟机 一个apps页面 一个我的页面 虚拟机就是现实所有安装的虚拟机 apps页面就是显示你在虚拟机安装的app 我的页面就是镜像下载管理啊 空间占用啊 日志查看啊 设置啊 设备详情啊 关于啊这些 apps页面的app可以通过start program启动 你在这里打开xx app就先确保虚拟机运行 然后呢 通过/shell:“C:\xxx.exe“运行 而且这里只打开这个app的远程窗口 如果需要文件互通 可以选择用户把鸿蒙里面的哪个文件夹映射到z盘啊 y盘啊这种的 你可以把 设备支不支持jit 支不支持KVM 支不支持桌面文件夹写入啊这个放在我的 设备详情这里面 当然 根据探测情况切换参数 比如说 支持jit就是 -accel KVM 不支持就是 -accel tcg, thread=multi 运行日志落沙箱 崩溃就重启vm线程 以及需要基本的资源限制 比如说默认开4核vCPU 6g内存 以及磁盘空间检查和警告 完成这个之后呢 就可以有Windows端/Linux段的客户机增强工具了 比如说一件启动rdp 防火墙规则 创建本地账号 安装驱动和qemu原有的qemu guest agent 然后呢 在freerdp里面实现自定义的dvc通道 然后嗯 宿主机端那边通过啥mediabridge啊啥的 上报state meta progress cover 执行play pause next prev seek volume 搞到鸿蒙宿主机 鸿蒙侧则是用avsession映射播放状态 接系统 耳机 蓝牙控制 并且通过dvc下发 就是这种的音乐控制透传的方式 然后呢 还可以共享剪贴板 可以长期挂载共享目录 通过9p啊 virtiofs啊 samba啊 在这三个里面随便选一个方式 以及可以实现快照 暂停 和恢复这种虚拟机都有的功能 以及 对增强工具动手脚 比如说 Windows端右键菜单 这里就有增强工具:把他固定在鸿蒙桌面 这样子就可以提取这个app的icon啊 名字啊 把他打包为一个代理app 通过deveco studio安装到鸿蒙平板和电脑上面 每次你打开这个代理app之后 他就直接启动vm 然后呢再用之前说过的/shell:“C:\xxx.lnk“啊这种的运行 下载镜像可以可视化队列 断点恢复 失败重试 速度和eta 甚至还有省电模式 比如说标准模式 节能模式 super turbo模式 甚至我的 设置那里面还有高级参数配置 允许你配置参数 比如说-accel tcg, thread=multi, tb-size=128这种的 完成了这些的话呢 最后一步则是 通过remoteapp啊 rail啊 在客户机那边发布应用 宿主机则是通过/app:”||app名字启动app 支持多窗口独立渲染 dpi和缩放可以自动匹配等等 甚至还可以设备重定向 比如说采集卡啊 u盘啊这种的 以及 你可以调用系统摄像头麦克风打视频 开会这种的 以及支持多vm 比如说Linux macOS的x86版本啊 甚至还有自动化和模版 比如说通过自定义的windows镜像安装增强工具啊 是否要求跳过oobe啊 Windows的应用市场啊这种 方便用户部署常用环境 甚至可以导出虚拟机到虚拟机格式的文件 方便转移 甚至可以与附近的鸿蒙电脑上的vm协同 查看和操作他里面的东西 甚至更甚 远端vm连接