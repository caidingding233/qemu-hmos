name: Build QEMU with Huawei's toolchain (legacy)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Update submodules (including qemu-code)
      run: |
        echo "=== Updating submodules ==="
        git submodule update --init --recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake curl wget unzip python3 \
                              libglib2.0-dev libpixman-1-dev libssl-dev \
                              libcurl4-openssl-dev libssh-dev libgnutls28-dev \
                              libsasl2-dev libpam0g-dev libbz2-dev libzstd-dev \
                              libpcre2-dev pkg-config meson tree \
                              binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu \
                              libc6-dev libc6-dev-arm64-cross \
                              libgnutls-openssl-dev  # Á°Æ‰øùgnutlsÂºÄÂèëÂåÖÂÆåÊï¥ÂÆâË£Ö

    - name: Download and setup SDK
      run: |
        echo "=== Downloading SDK ==="
        # Try multiple SDK URLs
        SDK_URLS=(
          "https://repo.huaweicloud.com/openharmony/os/5.1.0-Release/ohos-sdk-windows_linux-public.tar.gz"
          "https://repo.huaweicloud.com/openharmony/os/5.0.0-Release/ohos-sdk-windows_linux-public.tar.gz"
          "https://repo.huaweicloud.com/openharmony/os/4.1.0-Release/ohos-sdk-windows_linux-public.tar.gz"
        )
        
        SDK_DOWNLOADED=false
        for url in "${SDK_URLS[@]}"; do
          echo "Trying SDK URL: $url"
          if curl -L -o ohos-sdk.tar.gz "$url"; then
            echo "‚úÖ SDK downloaded successfully from: $url"
            SDK_DOWNLOADED=true
            break
          else
            echo "‚ùå Failed to download from: $url"
          fi
        done
        
        if [ "$SDK_DOWNLOADED" = false ]; then
          echo "‚ùå All SDK download attempts failed"
          exit 1
        fi
        
        echo "=== Extracting SDK ==="
        tar -xzf ohos-sdk.tar.gz
        rm ohos-sdk.tar.gz
        rm -rf ohos-sdk/{ohos,windows}
        
        echo "=== Analyzing SDK structure ==="
        echo "Root SDK structure:"
        ls -la ohos-sdk/
        
        echo ""
        echo "Linux SDK structure:"
        ls -la ohos-sdk/linux/
        
        echo ""
        echo "All files in linux directory:"
        find ohos-sdk/linux -type f | head -20

    - name: Find and extract native SDK
      run: |
        echo "=== Finding native SDK ==="
        cd ohos-sdk/linux
        
        # Look for any zip files that might contain native tools
        echo "Looking for zip files:"
        find . -name "*.zip" -type f
        
        # Try different patterns for native SDK
        NATIVE_PATTERNS=(
          "native-linux-x64-*.zip"
          "native-*.zip"
          "*native*.zip"
          "*-native-*.zip"
        )
        
        NATIVE_ZIP=""
        for pattern in "${NATIVE_PATTERNS[@]}"; do
          echo "Searching for pattern: $pattern"
          found=$(find . -name "$pattern" -type f | head -1)
          if [ -n "$found" ]; then
            NATIVE_ZIP="$found"
            echo "‚úÖ Found native SDK: $NATIVE_ZIP"
            break
          fi
        done
        
        if [ -z "$NATIVE_ZIP" ]; then
          echo "‚ùå No native SDK zip found"
          echo "Available files:"
          find . -type f | head -20
          echo ""
          echo "Trying to find any clang compiler directly:"
          find . -name "*clang*" -type f | head -10
          exit 1
        fi
        
        echo "=== Extracting native SDK ==="
        echo "Extracting: $NATIVE_ZIP"
        unzip -q "$NATIVE_ZIP"
        rm "$NATIVE_ZIP"
        
        # ÂÖàËÆæÁΩÆSYSROOTÂèòÈáèÔºåÂõ†‰∏∫ÂêéÈù¢ÈúÄË¶ÅÁî®Âà∞
        echo "=== ËÆæÁΩÆSYSROOTÂèòÈáè ==="
        # Êü•ÊâænativeÁõÆÂΩï
        NATIVE_DIR=""
        for pattern in "native-linux-x64-*" "native-*" "*native*"; do
          found=$(find . -name "$pattern" -type d | head -1)
          if [ -n "$found" ]; then
            NATIVE_DIR="$found"
            echo "‚úÖ Found with pattern '$pattern': $NATIVE_DIR"
            break
          fi
        done
        
        if [ -z "$NATIVE_DIR" ]; then
          NATIVE_DIR=$(find . -type d -name 'native' | head -1)
          if [ -n "$NATIVE_DIR" ]; then
            echo "‚úÖ Found generic native directory: $NATIVE_DIR"
          fi
        fi
        
        if [ -z "$NATIVE_DIR" ]; then
          echo "‚ùå No native directory found after extraction"
          exit 1
        fi
        
        export SYSROOT="$(pwd)/$NATIVE_DIR/sysroot"
        echo "SYSROOT set to: $SYSROOT"

        # È™åËØÅÂçé‰∏∫ SDK ÁöÑ musl Â§¥Êñá‰ª∂Á≥ªÁªü
        echo "=== È™åËØÅÂçé‰∏∫ SDK musl Â§¥Êñá‰ª∂Á≥ªÁªü ==="
        
        echo "Ê£ÄÊü•Âçé‰∏∫ SDK ÁöÑ musl Â§¥Êñá‰ª∂ÁªìÊûÑ..."
        echo "SYSROOT: $SYSROOT"
        
        # Ê£ÄÊü•ÂÖ≥ÈîÆÊñá‰ª∂ÊòØÂê¶Â≠òÂú®
        echo "Ê£ÄÊü•ÂÖ≥ÈîÆÂ§¥Êñá‰ª∂:"
        [ -f "$SYSROOT/usr/include/sys/socket.h" ] && echo "‚úì sys/socket.h Â≠òÂú®" || echo "‚úó sys/socket.h Áº∫Â§±"
        [ -f "$SYSROOT/usr/include/aarch64-linux-ohos/bits/alltypes.h" ] && echo "‚úì alltypes.h Â≠òÂú®" || echo "‚úó alltypes.h Áº∫Â§±"
        [ -f "$SYSROOT/usr/include/aarch64-linux-ohos/bits/socket.h" ] && echo "‚úì bits/socket.h Â≠òÂú®" || echo "‚úó bits/socket.h Áº∫Â§±"
        
        # Ê£ÄÊü•Á±ªÂûãÂÆö‰πâ
        echo "Ê£ÄÊü•Á±ªÂûãÂÆö‰πâ:"
        if grep -q "socklen_t" "$SYSROOT/usr/include/aarch64-linux-ohos/bits/alltypes.h" 2>/dev/null; then
          echo "‚úì socklen_t Â∑≤ÂÆö‰πâ"
        else
          echo "‚úó socklen_t Êú™ÂÆö‰πâ"
        fi
        
        if grep -q "sa_family_t" "$SYSROOT/usr/include/aarch64-linux-ohos/bits/alltypes.h" 2>/dev/null; then
          echo "‚úì sa_family_t Â∑≤ÂÆö‰πâ"
        else
          echo "‚úó sa_family_t Êú™ÂÆö‰πâ"
        fi
        
        echo "Âçé‰∏∫ SDK ‰ΩøÁî® musl libcÔºåÂ§¥Êñá‰ª∂ÁªìÊûÑÊ≠£Á°ÆÔºåÊó†ÈúÄÈ¢ùÂ§ñ‰øÆÂ§ç"
        
        echo "=== Analyzing extracted content ==="
        echo "Contents after extraction:"
        ls -la
        
        echo "‚úÖ Final native directory: $NATIVE_DIR"

        echo "=== Analyzing native directory ==="
        echo "Contents of $NATIVE_DIR:"
        ls -la "$NATIVE_DIR"

        # Persist native directory path for later steps
        echo "NATIVE_DIR=$NATIVE_DIR" >> $GITHUB_ENV
        
        echo ""
        echo "Looking for llvm directory:"
        find "$NATIVE_DIR" -name "llvm" -type d
        
        echo ""
        echo "Looking for build-tools directory:"
        find "$NATIVE_DIR" -name "build-tools" -type d
        
        echo ""
        echo "Looking for any clang compiler:"
        find "$NATIVE_DIR" -name "*clang*" -type f

    - name: Verify sysroot headers
      run: |
        echo "=== È™åËØÅsysrootÂ§¥Êñá‰ª∂Áä∂ÊÄÅ ==="
        echo "SYSROOT: $SYSROOT"
        echo "Checking sysroot structure:"
        ls -la "$SYSROOT" || echo "Cannot list SYSROOT"
        echo ""
        echo "Checking usr/include:"
        ls -la "$SYSROOT/usr/include" 2>/dev/null || echo "Cannot list usr/include"
        echo ""
        echo "Checking for key header files:"
        [ -f "$SYSROOT/usr/include/limits.h" ] && echo "‚úì limits.h exists" || echo "‚úó limits.h missing"
        [ -d "$SYSROOT/usr/include/bits" ] && echo "‚úì bits directory exists" || echo "‚úó bits directory missing"
        [ -f "$SYSROOT/usr/include/bits/limits.h" ] && echo "‚úì bits/limits.h exists" || echo "‚úó bits/limits.h missing"

    - name: Check available gnutls packages
      run: |
        echo "=== Ê£ÄÊü•ÂèØÁî®ÁöÑ gnutls ÂåÖ ==="
        echo "Searching for gnutls packages:"
        apt search gnutls 2>/dev/null | grep -E "^libgnutls.*dev|^gnutls.*dev" | head -10
        echo ""
        echo "Trying to install additional gnutls packages:"
        sudo apt-get install -y libgnutls28-dev libgnutls-openssl-dev || echo "Some packages may not be available"
        echo ""
        echo "Installed gnutls packages:"
        dpkg -l | grep gnutls || echo "No gnutls packages found"

    - name: Find gnutls headers
      run: |
        echo "=== üîç Êü•Êâæ gnutls Â§¥Êñá‰ª∂‰ΩçÁΩÆ ==="
        
        # ËøõÂ∫¶Êù°ÂáΩÊï∞
        show_progress() {
          local current=$1
          local total=$2
          local desc=$3
          local percent=$((current * 100 / total))
          local filled=$((percent / 2))
          local empty=$((50 - filled))
          printf "\r["
          printf "%*s" $filled | tr ' ' '='
          printf "%*s" $empty | tr ' ' ' '
          printf "] %d%% %s" $percent "$desc"
        }
        
        echo "üìã Ê£ÄÊü•Ê†áÂáÜ gnutls ‰ΩçÁΩÆ..."
        show_progress 1 4 "Ê£ÄÊü• /usr/include/gnutls/"
        [ -f "/usr/include/gnutls/gnutls.h" ] && echo " ‚úÖ" || echo " ‚ùå"
        
        show_progress 2 4 "Ê£ÄÊü• /usr/include/x86_64-linux-gnu/gnutls/"
        [ -f "/usr/include/x86_64-linux-gnu/gnutls/gnutls.h" ] && echo " ‚úÖ" || echo " ‚ùå"
        
        show_progress 3 4 "Ê£ÄÊü• /usr/lib/x86_64-linux-gnu/gnutls/"
        [ -f "/usr/lib/x86_64-linux-gnu/gnutls/gnutls.h" ] && echo " ‚úÖ" || echo " ‚ùå"
        
        show_progress 4 4 "ÂàÜÊûêÁªìÊûú..."
        echo ""
        
        echo "üì¶ Â∑≤ÂÆâË£ÖÁöÑ gnutls ÂåÖ:"
        dpkg -l | grep gnutls | head -5 || echo "   (Êó† gnutls ÂåÖ)"
        echo ""
        
        echo "üéØ ËÆæÁΩÆ gnutls Â§¥Êñá‰ª∂Ë∑ØÂæÑ..."
        if [ -f "/usr/include/gnutls/gnutls.h" ]; then
          echo "GNUTLS_HEADER_PATH=/usr/include/gnutls" >> $GITHUB_ENV
          echo "‚úÖ ‰ΩøÁî® /usr/include/gnutls"
        elif [ -f "/usr/include/x86_64-linux-gnu/gnutls/gnutls.h" ]; then
          echo "GNUTLS_HEADER_PATH=/usr/include/x86_64-linux-gnu/gnutls" >> $GITHUB_ENV
          echo "‚úÖ ‰ΩøÁî® /usr/include/x86_64-linux-gnu/gnutls"
        elif [ -f "/usr/lib/x86_64-linux-gnu/gnutls/gnutls.h" ]; then
          echo "GNUTLS_HEADER_PATH=/usr/lib/x86_64-linux-gnu/gnutls" >> $GITHUB_ENV
          echo "‚úÖ ‰ΩøÁî® /usr/lib/x86_64-linux-gnu/gnutls"
        else
          echo "‚ö†Ô∏è  Êú™ÊâæÂà∞ gnutls Â§¥Êñá‰ª∂ÔºåÂ∞ÜÁ¶ÅÁî® gnutls ÊîØÊåÅ"
          echo "GNUTLS_HEADER_PATH=" >> $GITHUB_ENV
        fi
        echo ""

    - name: Setup environment and test
      run: |
        echo "=== Setting up environment ==="
        cd ohos-sdk/linux
        
        # Set up paths based on what we found
        export OHOS_NDK_HOME="$(pwd)/$NATIVE_DIR"
        export SYSROOT="$(pwd)/$NATIVE_DIR/sysroot"
        
        # Try to find clang compiler
        CLANG_CANDIDATES=(
          "$(pwd)/$NATIVE_DIR/llvm/bin/aarch64-unknown-linux-ohos-clang"
          "$(pwd)/$NATIVE_DIR/llvm/bin/clang"
          "$(pwd)/$NATIVE_DIR/bin/aarch64-unknown-linux-ohos-clang"
          "$(pwd)/$NATIVE_DIR/bin/clang"
        )
        
        CC=""
        for candidate in "${CLANG_CANDIDATES[@]}"; do
          if [ -f "$candidate" ]; then
            CC="$candidate"
            echo "‚úÖ Found CC: $CC"
            break
          fi
        done
        
        if [ -z "$CC" ]; then
          echo "‚ùå No clang compiler found"
          echo "Available files in native directory:"
          find "$NATIVE_DIR" -type f | head -20
          LLVM_BIN_DIR="$(pwd)/$NATIVE_DIR/llvm/bin"
          if [ -d "$LLVM_BIN_DIR" ]; then
            echo ""
            echo "Attempting fallback discovery in $LLVM_BIN_DIR"
            CLANG_AUTO=$(find "$LLVM_BIN_DIR" -maxdepth 1 -name "clang*" -type f | head -1)
            if [ -n "$CLANG_AUTO" ]; then
              echo "‚úÖ Auto-detected CC candidate: $CLANG_AUTO"
              CC="$CLANG_AUTO"
            fi
          fi
        fi

        if [ -z "$CC" ]; then
          echo "‚ùå Still no clang compiler found"
          exit 1
        fi
        
        # Try to find C++ compiler
        CXX_CANDIDATES=(
          "$(pwd)/$NATIVE_DIR/llvm/bin/aarch64-unknown-linux-ohos-clang++"
          "$(pwd)/$NATIVE_DIR/llvm/bin/clang++"
          "$(pwd)/$NATIVE_DIR/bin/aarch64-unknown-linux-ohos-clang++"
          "$(pwd)/$NATIVE_DIR/bin/clang++"
        )
        
        CXX=""
        for candidate in "${CXX_CANDIDATES[@]}"; do
          if [ -f "$candidate" ]; then
            CXX="$candidate"
            echo "‚úÖ Found CXX: $CXX"
            break
          fi
        done
        
        if [ -z "$CXX" ]; then
          echo "‚ö†Ô∏è No C++ compiler found, using CC for CXX"
          LLVM_BIN_DIR="$(pwd)/$NATIVE_DIR/llvm/bin"
          if [ -d "$LLVM_BIN_DIR" ]; then
            CLANGXX_AUTO=$(find "$LLVM_BIN_DIR" -maxdepth 1 -name "clang++*" -type f | head -1)
            if [ -n "$CLANGXX_AUTO" ]; then
              echo "‚úÖ Auto-detected clang++ candidate: $CLANGXX_AUTO"
              CXX="$CLANGXX_AUTO"
            fi
          fi
        fi

        if [ -z "$CXX" ]; then
          echo "‚ö†Ô∏è Falling back to CC for CXX"
          CXX="$CC"
        fi
        
        # Try to find CMake
        CMAKE_CANDIDATES=(
          "$(pwd)/$NATIVE_DIR/build-tools/cmake/bin/cmake"
          "$(pwd)/$NATIVE_DIR/cmake/bin/cmake"
          "$(pwd)/$NATIVE_DIR/bin/cmake"
          "/usr/bin/cmake"
        )
        
        CMAKE=""
        for candidate in "${CMAKE_CANDIDATES[@]}"; do
          if [ -f "$candidate" ]; then
            CMAKE="$candidate"
            echo "‚úÖ Found CMake: $CMAKE"
            break
          fi
        done
        
        if [ -z "$CMAKE" ]; then
          echo "‚ùå No CMake found"
          exit 1
        fi
        
        echo "=== Final environment ==="
        echo "OHOS_NDK_HOME: $OHOS_NDK_HOME"
        echo "SYSROOT: $SYSROOT"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "CMAKE: $CMAKE"
        
        echo ""
        echo "=== Testing tools ==="
        echo "Testing CC:"
        file "$CC"
        "$CC" --version 2>&1 | head -3 || echo "CC version check failed"
        
        echo ""
        echo "Testing CMake:"
        "$CMAKE" --version | head -3 || echo "CMake version check failed"
        
        # Save environment for next steps
        echo "OHOS_NDK_HOME=$OHOS_NDK_HOME" >> $GITHUB_ENV
        echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "CMAKE=$CMAKE" >> $GITHUB_ENV

    - name: Build QEMU
      run: |
        echo "=== Restoring environment variables ==="
        # Restore environment variables from previous step
        export OHOS_NDK_HOME="$OHOS_NDK_HOME"
        export SYSROOT="$SYSROOT"
        export CC="$CC"
        export CXX="$CXX"
        export CMAKE="$CMAKE"

        echo "=== Building QEMU ==="
        cd third_party/qemu

        mkdir -p build
        cd build

        echo "Environment check:"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "SYSROOT: $SYSROOT"
        
        echo ""
        echo "=== Testing posix_memalign availability ==="
        # ÊµãËØï posix_memalign ÊòØÂê¶ÂèØÁî®ÔºàË∑≥ËøáÊâßË°åÊµãËØïÔºåÂõ†‰∏∫‰∫§ÂèâÁºñËØëÔºâ
        cat > test_memalign.c << 'EOF'
        #include <stdlib.h>
        #include <stdio.h>
        int main() {
            void *ptr;
            int ret = posix_memalign(&ptr, 16, 1024);
            if (ret == 0) {
                printf("posix_memalign available\n");
                free(ptr);
                return 0;
            } else {
                printf("posix_memalign failed: %d\n", ret);
                return 1;
            }
        }
        EOF
        
        # Âè™ÊµãËØïÁºñËØëÔºå‰∏çÊâßË°åÔºàÂõ†‰∏∫‰∫§ÂèâÁºñËØëÔºâ
        if "$CC" -o test_memalign test_memalign.c 2>/dev/null; then
            echo "‚úÖ posix_memalign compiles successfully"
            export POSIX_MEMALIGN_AVAILABLE=1
        else
            echo "‚ö†Ô∏è posix_memalign compilation failed, will use fallback"
            export POSIX_MEMALIGN_AVAILABLE=0
        fi
        rm -f test_memalign.c test_memalign
        
        echo ""
        echo "=== Testing compiler availability ==="
        # ÊµãËØïÁºñËØëÂô®ÊòØÂê¶ÁúüÁöÑÂèØÁî®
        echo "Testing CC: $CC"
        if [ -f "$CC" ]; then
            echo "‚úÖ CC exists: $CC"
            file "$CC"
            "$CC" --version 2>&1 | head -3 || echo "CC version check failed"
        else
            echo "‚ùå CC not found: $CC"
            echo "Available files in llvm/bin:"
            ls -la "$(dirname "$CC")" || echo "Cannot list llvm/bin"
            exit 1
        fi
        
        echo ""
        echo "Testing CXX: $CXX"
        if [ -f "$CXX" ]; then
            echo "‚úÖ CXX exists: $CXX"
            file "$CXX"
            "$CXX" --version 2>&1 | head -3 || echo "CXX version check failed"
        else
            echo "‚ùå CXX not found: $CXX"
            exit 1
        fi
        
        echo ""
        echo "=== Running Configure ==="
        # ‰ΩøÁî®Âçé‰∏∫ÁöÑÁºñËØëÂô®ÂåÖË£ÖËÑöÊú¨ÔºåËÆ©ÂÆÉËá™Âä®Â§ÑÁêÜ musl Â§¥Êñá‰ª∂
        # Ê∑ªÂä† gnutls Â§¥Êñá‰ª∂Ë∑ØÂæÑÔºåËß£ÂÜ≥‰∫§ÂèâÁºñËØëÈóÆÈ¢ò
        # ÂÖàÂàõÂª∫ posix_memalign_fallback.h Êñá‰ª∂Ôºå‰æõ configure ‰ΩøÁî®
        echo "Creating posix_memalign_fallback.h for configure phase"
        # Á°Æ‰øùÊñá‰ª∂Âú® build ÁõÆÂΩï‰∏≠ÂàõÂª∫
        cat > posix_memalign_fallback.h << 'EOF'
        #ifndef POSIX_MEMALIGN_FALLBACK_H
        #define POSIX_MEMALIGN_FALLBACK_H
        
        #include <stdlib.h>
        #include <errno.h>
        #include <stdint.h>
        
        // Fallback implementation of posix_memalign for HarmonyOS musl
        static inline int posix_memalign_fallback(void **memptr, size_t alignment, size_t size) {
            if (alignment < sizeof(void*) || (alignment & (alignment - 1)) != 0) {
                return EINVAL;
            }
            
            // Use aligned_alloc if available, otherwise use malloc + manual alignment
            #ifdef __GLIBC__
            *memptr = aligned_alloc(alignment, size);
            return *memptr ? 0 : ENOMEM;
            #else
            // Fallback: allocate extra space and align manually
            void *ptr = malloc(size + alignment - 1);
            if (!ptr) return ENOMEM;
            
            uintptr_t addr = (uintptr_t)ptr;
            uintptr_t aligned = (addr + alignment - 1) & ~(alignment - 1);
            *memptr = (void*)aligned;
            return 0;
            #endif
        }
        
        // Override posix_memalign if not available
        #ifndef CONFIG_POSIX_MEMALIGN
        #define posix_memalign posix_memalign_fallback
        #endif
        
        #endif
        EOF

        # Ëé∑ÂèñÁªùÂØπË∑ØÂæÑ
        FALLBACK_H_PATH="$(pwd)/posix_memalign_fallback.h"
        echo "Fallback header path: $FALLBACK_H_PATH"
        
        # ‰ΩøÁî®ÁéØÂ¢ÉÂèòÈáè‰∏≠ÁöÑ gnutls Â§¥Êñá‰ª∂Ë∑ØÂæÑ
        echo "=== ‰ΩøÁî® gnutls Â§¥Êñá‰ª∂Ë∑ØÂæÑ ==="
        echo "GNUTLS_HEADER_PATH from previous step: $GNUTLS_HEADER_PATH"
        
        if [ -n "$GNUTLS_HEADER_PATH" ] && [ -f "$GNUTLS_HEADER_PATH/gnutls.h" ]; then
          GNUTLS_INCLUDE_PATHS="-I$GNUTLS_HEADER_PATH"
          echo "‚úì Using gnutls headers from: $GNUTLS_HEADER_PATH"
        else
          echo "‚ùå No valid gnutls headers found, will disable gnutls support"
          GNUTLS_INCLUDE_PATHS=""
        fi
        
        echo "Final gnutls include paths: $GNUTLS_INCLUDE_PATHS"
        
        export CFLAGS="-march=armv8-a $GNUTLS_INCLUDE_PATHS -DCONFIG_POSIX_MEMALIGN=1 -include $FALLBACK_H_PATH"
        export CXXFLAGS="-march=armv8-a $GNUTLS_INCLUDE_PATHS -DCONFIG_POSIX_MEMALIGN=1 -include $FALLBACK_H_PATH"
        export CPPFLAGS="$GNUTLS_INCLUDE_PATHS"
        export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH"
        export LDFLAGS="-L${SYSROOT}/usr/lib -L/usr/lib/x86_64-linux-gnu"
        
        # Á°Æ‰øùÁéØÂ¢ÉÂèòÈáèÊ≠£Á°ÆËÆæÁΩÆ
        export CC="$CC"
        export CXX="$CXX"
        export PATH="$(dirname "$CC"):$PATH"
        
        echo "Final environment before configure:"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "PATH: $PATH"
        
        # ÊµãËØïÁºñËØëÂô®ÊòØÂê¶ËÉΩÊ≠£Â∏∏Â∑•‰Ωú
        echo "Testing compiler with simple test:"
        echo 'int main() { return 0; }' > test_cc.c
        if "$CC" -o test_cc test_cc.c 2>&1; then
            echo "‚úÖ CC test compilation successful"
        else
            echo "‚ùå CC test compilation failed"
            echo "CC output:"
            "$CC" -o test_cc test_cc.c 2>&1 || true
        fi
        rm -f test_cc.c test_cc
        
        # ÂêØÁî® configure ÁöÑËØ¶ÁªÜÊó•Âøó
        export CONFIGURE_DEBUG=1
        
        # ËÆæÁΩÆ PKG_CONFIG_PATH ‰Ωú‰∏∫ÁéØÂ¢ÉÂèòÈáèÔºà‰∏çÊòØ configure ÂèÇÊï∞Ôºâ
        export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH"
        
        # Ê†πÊçÆ gnutls Â§¥Êñá‰ª∂ÂèØÁî®ÊÄßÂÜ≥ÂÆöÊòØÂê¶ÂêØÁî® gnutls
        if [ -n "$GNUTLS_INCLUDE_PATHS" ]; then
          GNUTLS_OPTION="--enable-gnutls"
          echo "‚úì Enabling gnutls support"
        else
          GNUTLS_OPTION="--disable-gnutls"
          echo "‚ö†Ô∏è Disabling gnutls support (headers not found)"
        fi
        
        # ËøêË°å configure Âπ∂ÊçïËé∑ÈÄÄÂá∫Á†Å
        if ! ../configure \
          --target-list=aarch64-softmmu \
          --cc="$CC" \
          --cxx="$CXX" \
          --host-cc="/usr/bin/cc" \
          --cross-prefix="" \
          --extra-cflags="-march=armv8-a $GNUTLS_INCLUDE_PATHS -DCONFIG_POSIX_MEMALIGN=1 -include $FALLBACK_H_PATH -D__aarch64__" \
          --extra-cxxflags="-march=armv8-a $GNUTLS_INCLUDE_PATHS -DCONFIG_POSIX_MEMALIGN=1 -include $FALLBACK_H_PATH -D__aarch64__" \
          --extra-ldflags="-L${SYSROOT}/usr/lib -L/usr/lib/x86_64-linux-gnu" \
          -Db_staticpic=true \
          -Ddefault_library=static \
          -Dtools=disabled \
          --enable-tcg \
          --disable-kvm \
          --disable-xen \
          --disable-werror \
          --enable-vnc \
          --enable-slirp \
          --enable-curl \
          --enable-fdt \
          --enable-guest-agent \
          --enable-vhost-user \
          --enable-vhost-net \
          --disable-keyring \
          --enable-tpm \
          --disable-gtk \
          --disable-sdl \
          --disable-vte \
          --disable-curses \
          --disable-brlapi \
          --disable-spice \
          --disable-usb-redir \
          --disable-lzo \
          --disable-snappy \
          --disable-bzip2 \
          --disable-lzfse \
          --disable-zstd \
          --disable-libssh \
          --disable-nettle \
          --disable-gcrypt \
          $GNUTLS_OPTION; then
            echo "‚ùå Configure failed, showing detailed logs:"
            echo "=== config.log content ==="
            if [ -f "config.log" ]; then
                cat config.log
            else
                echo "config.log not found"
            fi
            echo "=== End of config.log ==="
            exit 1
        fi
        
        echo "‚úÖ Configure completed!"
        
        echo "=== Fixing posix_memalign detection ==="
        # Âçé‰∏∫ SDK Êúâ posix_memalign Â£∞Êòé‰ΩÜÊ≤°ÊúâÂÆûÁé∞ÔºåÊàë‰ª¨ÈúÄË¶ÅÂº∫Âà∂ÂêØÁî®
        echo "Force enabling CONFIG_POSIX_MEMALIGN for HarmonyOS musl compatibility"
        
        # posix_memalign_fallback.h Â∑≤ÁªèÂú® configure ‰πãÂâçÂàõÂª∫‰∫Ü
        
        # Êü•ÊâæÂπ∂‰øÆÂ§çÊâÄÊúâÂèØËÉΩÁöÑÈÖçÁΩÆÊñá‰ª∂
        for config_file in "config.h" "config-host.h" "config-target.h"; do
            if [ -f "$config_file" ]; then
                echo "Processing $config_file"
                # ÁßªÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑ CONFIG_POSIX_MEMALIGN ÂÆö‰πâ
                sed -i '/CONFIG_POSIX_MEMALIGN/d' "$config_file"
                # Ê∑ªÂä†Ê≠£Á°ÆÁöÑÂÆö‰πâ
                echo "#define CONFIG_POSIX_MEMALIGN 1" >> "$config_file"
                echo "‚úì Added CONFIG_POSIX_MEMALIGN to $config_file"
            fi
        done
        
        # Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÈÖçÁΩÆÊñá‰ª∂ÔºåÂàõÂª∫‰∏Ä‰∏™
        if [ ! -f "config.h" ] && [ ! -f "config-host.h" ]; then
            echo "Creating config.h with CONFIG_POSIX_MEMALIGN"
            echo "#define CONFIG_POSIX_MEMALIGN 1" > config.h
        fi
        
        # È™åËØÅ‰øÆÂ§çÁªìÊûú
        echo "Verifying CONFIG_POSIX_MEMALIGN definition:"
        grep -r "CONFIG_POSIX_MEMALIGN" . || echo "No CONFIG_POSIX_MEMALIGN found"
        
        echo "=== üöÄ ÊûÑÂª∫ QEMU ==="
        
        # ËøõÂ∫¶Êù°ÂáΩÊï∞
        show_progress() {
          local current=$1
          local total=$2
          local desc=$3
          local percent=$((current * 100 / total))
          local filled=$((percent / 2))
          local empty=$((50 - filled))
          printf "\r["
          printf "%*s" $filled | tr ' ' '='
          printf "%*s" $empty | tr ' ' ' '
          printf "] %d%% %s" $percent "$desc"
        }
        
        show_progress 1 5 "ËÆæÁΩÆÈìæÊé•Âô®Â∑•ÂÖ∑..."
        # ËÆæÁΩÆÊ≠£Á°ÆÁöÑÈìæÊé•Âô®ÁéØÂ¢ÉÂèòÈáèÔºå‰ΩøÁî®OHOS NDKÁöÑÂ∑•ÂÖ∑
        export LD="$CC"
        export AR="$(dirname "$CC")/llvm-ar"
        export RANLIB="$(dirname "$CC")/llvm-ranlib"
        export STRIP="$(dirname "$CC")/llvm-strip"
        
        # Â¶ÇÊûúÊâæ‰∏çÂà∞llvmÂ∑•ÂÖ∑Ôºå‰ΩøÁî®Á≥ªÁªüÂ∑•ÂÖ∑
        [ ! -f "$AR" ] && export AR="aarch64-linux-gnu-ar"
        [ ! -f "$RANLIB" ] && export RANLIB="aarch64-linux-gnu-ranlib"
        [ ! -f "$STRIP" ] && export STRIP="aarch64-linux-gnu-strip"
        echo " ‚úÖ"
        
        show_progress 2 5 "È™åËØÅÂ∑•ÂÖ∑Èìæ..."
        echo "üîß ‰ΩøÁî®Â∑•ÂÖ∑:"
        echo "   LD: $LD"
        echo "   AR: $AR"
        echo "   RANLIB: $RANLIB"
        echo "   STRIP: $STRIP"
        echo " ‚úÖ"
        
        show_progress 3 5 "ÂºÄÂßãÁºñËØë..."
        echo "‚öôÔ∏è  ‰ΩøÁî® $(nproc) ‰∏™Âπ∂Ë°å‰ªªÂä°ÁºñËØë QEMU..."
        echo "üìä ÁºñËØëËøõÂ∫¶:"
        
        # ÂêØÂä®ÁºñËØëÂπ∂ÊòæÁ§∫ËøõÂ∫¶
        make -j$(nproc) 2>&1 | while IFS= read -r line; do
          if [[ $line =~ \[([0-9]+)/([0-9]+)\] ]]; then
            current="${BASH_REMATCH[1]}"
            total="${BASH_REMATCH[2]}"
            show_progress $current $total "ÁºñËØë‰∏≠..."
          else
            echo ""
            echo "$line"
          fi
        done
        
        show_progress 5 5 "ÁºñËØëÂÆåÊàê!"
        echo " ‚úÖ"
        
        echo "‚úÖ QEMU build completed!"
        
        echo "=== Checking build results ==="
        ls -la qemu-system-aarch64 || echo "Main binary not found"
        find . -name "*.so" -o -name "*.a" | head -10
        
        echo "=== Creating libqemu_full.so ==="
        # ÂàõÂª∫ libqemu_full.so Áî®‰∫éÈ∏øËíô App
        if [ -f "qemu-system-aarch64" ]; then
            echo "Creating libqemu_full.so from qemu-system-aarch64..."
            cp qemu-system-aarch64 libqemu_full.so
            echo "‚úì libqemu_full.so created successfully"
            ls -la libqemu_full.so
        else
            echo "‚úó qemu-system-aarch64 not found, cannot create libqemu_full.so"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qemu-harmonyos-build
        path: |
          third_party/qemu/build/qemu-system-aarch64
          third_party/qemu/build/libqemu_full.so
          third_party/qemu/build/*.so
          third_party/qemu/build/*.a
        retention-days: 7
