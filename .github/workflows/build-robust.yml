name: Build QEMU for HarmonyOS (Robust)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: ä¸‹ä¸‹æ¥
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ç„¶åŽå®‰è£…æœ€å°çš„ä¾èµ– (ä»…ä¸»æœºå·¥å…·)
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl wget unzip python3 \
                                pkg-config git ca-certificates \
                                libglib2.0-dev libpixman-1-dev \
                                libzstd-dev zstd

    - name: å†å‘¢å°±æ˜¯è®¾ç½® Python (ç”¨äºŽ Meson/Ninja)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ä¸‹ä¸€æ­¥ä¸‹ Meson>=1.6 & Ninja, å¹¶é”å®š PATH
      run: |
        python -m pip install --upgrade --user 'meson>=1.6.0' 'ninja>=1.11'
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        MESON_BIN="$(python -c 'import shutil;print(shutil.which("meson"))')"
        NINJA_BIN="$(python -c 'import shutil;print(shutil.which("ninja"))')"
        echo "MESON=$MESON_BIN" >> $GITHUB_ENV
        echo "NINJA=$NINJA_BIN" >> $GITHUB_ENV
        echo "Using MESON=$MESON_BIN"
        echo "Using NINJA=$NINJA_BIN"
        "$MESON_BIN" --version
        "$NINJA_BIN" --version
        # Hard guard: fail if < 1.5
        if ! "$MESON_BIN" --version | awk '{split($1,a,"."); exit !((a[1] > 1) || (a[1]==1 && a[2]>=5));}'; then
          echo "::error::Meson too old"; exit 1; fi
        type -a meson || true

    - name: å†å°±æ˜¯ä¸‹é¸¿è’™çš„ NDK (linuxç‰ˆ)
      run: |
        set -e
        urls=(
          "https://repo.huaweicloud.com/openharmony/os/5.1.0-Release/ohos-sdk-windows_linux-public.tar.gz"
          "https://repo.huaweicloud.com/openharmony/os/5.0.0-Release/ohos-sdk-windows_linux-public.tar.gz"
          "https://repo.huaweicloud.com/openharmony/os/4.1.0-Release/ohos-sdk-windows_linux-public.tar.gz"
        )
        for u in "${urls[@]}"; do
          echo "Try $u"
          if curl -L --retry 3 -o ohos-sdk.tar.gz "$u"; then
            break
          fi
        done
        tar -xzf ohos-sdk.tar.gz
        rm -f ohos-sdk.tar.gz
        # ä»…ä¿ç•™ linux ç›®å½•
        rm -rf ohos-sdk/ohos ohos-sdk/windows || true
        ls -la ohos-sdk/linux

    - name: çŽ°åœ¨æ¥æ‰¾æ‰¾åˆ° native å·¥å…·é“¾ (clang & sysroot)
      id: ndk
      run: |
        set -e
        cd ohos-sdk/linux
        # æ‰¾ native åŒ…
        zip=$(find . -type f -name "*native*linux*x64*.zip" -o -name "*native*linux*.zip" | head -1)
        [ -n "$zip" ] || { echo "No native SDK zip found"; exit 1; }
        unzip -q "$zip"
        rm -f "$zip"

        native_dir=$(find . -maxdepth 1 -type d -name "native-*" -o -name "*native*" | head -1)
        [ -n "$native_dir" ] || { echo "No native dir"; exit 1; }

        llvm_bin="$PWD/$native_dir/llvm/bin"
        sysroot="$PWD/$native_dir/sysroot"

        # ä¼˜å…ˆä½¿ç”¨å¸¦ triple çš„ç¼–è¯‘å™¨
        if [ -x "$llvm_bin/aarch64-unknown-linux-ohos-clang" ]; then
          cc="$llvm_bin/aarch64-unknown-linux-ohos-clang"
          cxx="$llvm_bin/aarch64-unknown-linux-ohos-clang++"
        else
          cc="$llvm_bin/clang"
          cxx="$llvm_bin/clang++"
        fi

        echo "OHOS_NDK_HOME=$PWD/$native_dir" >> $GITHUB_ENV
        echo "SYSROOT=$sysroot" >> $GITHUB_ENV
        echo "CC=$cc" >> $GITHUB_ENV
        echo "CXX=$cxx" >> $GITHUB_ENV
        echo "AR=$llvm_bin/llvm-ar" >> $GITHUB_ENV
        echo "RANLIB=$llvm_bin/llvm-ranlib" >> $GITHUB_ENV
        echo "STRIP=$llvm_bin/llvm-strip" >> $GITHUB_ENV

        echo "ndk_dir=$native_dir" >> $GITHUB_OUTPUT

    - name: åœ¨å‡†å¤‡ Meson è¦ç”¨çš„äº¤å‰ç¼–è¯‘æ–‡ä»¶(aarch64-ohos.ini)
      run: |
        set -e
        mkdir -p cross
        cat > cross/aarch64-ohos.ini <<EOF
        [binaries]
        c = '${CC}'
        cpp = '${CXX}'
        ar = '${AR}'
        strip = '${STRIP}'
        pkgconfig = 'pkg-config'
        ld = '${CC}'

        [host_machine]
        system = 'linux'
        cpu_family = 'aarch64'
        cpu = 'armv8'
        endian = 'little'

        [built-in options]
        c_args = ['--sysroot=${SYSROOT}','-fPIC','-O2','-pipe','-fvisibility=hidden','-nostdinc','-I${SYSROOT}/usr/include','-I/usr/include/glib-2.0','-I/usr/lib/x86_64-linux-gnu/glib-2.0/include']
        cpp_args = ['--sysroot=${SYSROOT}','-fPIC','-O2','-pipe','-fvisibility=hidden','-nostdinc','-I${SYSROOT}/usr/include','-I/usr/include/glib-2.0','-I/usr/lib/x86_64-linux-gnu/glib-2.0/include']
        c_link_args = ['--sysroot=${SYSROOT}']
        cpp_link_args = ['--sysroot=${SYSROOT}']
        EOF
        echo "Cross file written to: $GITHUB_WORKSPACE/cross/aarch64-ohos.ini"
        ls -la cross
        echo "Preview:"
        sed -n '1,80p' cross/aarch64-ohos.ini

    - name: å†å°±æ˜¯æä¾›å­é¡¹ç›® (pcre2/libffi é€šè¿‡ wrapsåŒ…ï¼Œglib/pixmanç”¨ç³»ç»Ÿçš„)
      run: |
        set -e
        cd third_party/qemu
        mkdir -p subprojects
        "$MESON" wrap install pcre2
        "$MESON" wrap install libffi
        ls -la subprojects

    - name: æœ€åŽå°±æ˜¯å¼€å§‹æž„å»ºQEMU(ARM + X86 å¤šç›®æ ‡æž„å»º)
      run: |
        set -e
        echo "MESON is $MESON"
        echo "NINJA is $NINJA"
        if [ ! -x "$MESON" ]; then
          echo "::error::MESON not found or not executable at $MESON"
          which meson || true
          ls -la "$HOME/.local/bin" || true
          exit 1
        fi
        # Export pkg-configï¼šåªä½¿ç”¨ OHOS sysrootï¼Œé¿å…ä¸»æœºç³»ç»Ÿå¤´æ–‡ä»¶æ±¡æŸ“
        export PKG_CONFIG_DIR=
        export PKG_CONFIG_PATH="${SYSROOT}/usr/lib/pkgconfig:${SYSROOT}/usr/share/pkgconfig:${SYSROOT}/lib/pkgconfig"
        echo "PKG_CONFIG_PATH=${PKG_CONFIG_PATH}"
        CROSS_FILE="$GITHUB_WORKSPACE/cross/aarch64-ohos.ini"
        echo "Using CROSS_FILE=$CROSS_FILE"
        if [ ! -f "$CROSS_FILE" ]; then
          echo "::error::Cross file not found at $CROSS_FILE"
          ls -la "$GITHUB_WORKSPACE" || true
          ls -la "$GITHUB_WORKSPACE/cross" || true
          exit 1
        fi
        cd third_party/qemu
        rm -rf build && mkdir build && cd build

        # Detect whether this QEMU fork exposes 'target_list' in meson_options.txt
        TLIST_ARG=""
        if [ -f ../meson_options.txt ] && grep -q "option('target_list'" ../meson_options.txt; then
          TLIST_ARG="-Dtarget_list=aarch64-softmmu,x86_64-softmmu,i386-softmmu"
          echo "Detected target_list option; will pass: ${TLIST_ARG}"
        else
          echo "This QEMU does not define 'target_list'; building project defaults."
        fi

        # ðŸ”§ ä¿®å¤ slirp æµ‹è¯•ç¨‹åºçš„æž¶æž„å†²çªï¼šç¦ç”¨æµ‹è¯•ç¨‹åºæž„å»º
        echo "=== ä¿®è¡¥ slirp å­é¡¹ç›®ï¼Œç¦ç”¨æµ‹è¯•ç¨‹åº ==="
        if [ -f "../subprojects/slirp/meson.build" ]; then
          # å¤‡ä»½åŽŸå§‹æ–‡ä»¶
          cp ../subprojects/slirp/meson.build ../subprojects/slirp/meson.build.bak
          
          # æ³¨é‡ŠæŽ‰æµ‹è¯•ç¨‹åºæž„å»º
          sed -i "s/^executable('pingtest'/# executable('pingtest'/" ../subprojects/slirp/meson.build || true
          sed -i "s/^test('pingtest'/# test('pingtest'/" ../subprojects/slirp/meson.build || true
          
          echo "âœ… slirp æµ‹è¯•ç¨‹åºå·²ç¦ç”¨"
        else
          echo "âš ï¸  slirp meson.build æœªæ‰¾åˆ°ï¼Œè·³è¿‡ä¿®è¡¥"
        fi

        # é¸¿è’™ç‰ˆ UTM å¤šç›®æ ‡æž„å»ºï¼šä½¿ç”¨ configure è„šæœ¬ï¼ˆå®ƒä¼šè°ƒç”¨ mesonï¼‰
        ../configure \
          --cross-prefix="" \
          --cc="${CC}" \
          --cxx="${CXX}" \
          --host-cc="/usr/bin/cc" \
          --target-list=aarch64-softmmu,x86_64-softmmu,i386-softmmu \
          --extra-cflags="--sysroot=${SYSROOT} -fPIC -march=armv8-a -Wno-error=typedef-redefinition -Wno-error=macro-redefined" \
          --extra-ldflags="--sysroot=${SYSROOT}" \
          --disable-gnutls \
          --disable-gtk --disable-sdl --disable-curses --disable-vte \
          --disable-brlapi --disable-spice --disable-libssh \
          --disable-nettle --disable-gcrypt \
          --enable-tcg \
          --enable-slirp \
          --enable-vnc \
          -Dwrap_mode=forcefallback \
          -Ddefault_library=static \
          -Db_staticpic=true \
          -Dvhost_user=disabled \
          -Dvhost_user_blk_server=disabled \
          -Dlibvduse=disabled \
          -Dvduse_blk_export=disabled \
          -Dvhost_net=disabled \
          -Dvhost_kernel=disabled \
          -Dkeyring=disabled \
          -Dzstd=disabled \
          -Dguest_agent=disabled \
          -Dtools=disabled

        # æž„å»ºæ‰€æœ‰ç›®æ ‡
        "$NINJA" -v -j"$(nproc)"

        echo "=== æž„å»ºäº§ç‰©æ£€æŸ¥ ==="
        for bin in qemu-system-aarch64 qemu-system-x86_64 qemu-system-i386; do
          if [ -f "$bin" ]; then
            ls -lh "$bin"
            file "$bin" || true
          else
            echo "Note: $bin not built in this configuration."
          fi
        done
        
        # äº§ç‰©ï¼šä¼˜å…ˆä½¿ç”¨ aarch64ï¼Œå¦‚ä¸å­˜åœ¨åˆ™æŒ‘é€‰å·²ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªç³»ç»Ÿä»¿çœŸå™¨
        OUT_SO=""
        for cand in qemu-system-aarch64 qemu-system-x86_64 qemu-system-i386; do
          if [ -f "$cand" ]; then OUT_SO="$cand"; break; fi
        done
        if [ -n "$OUT_SO" ]; then
          cp "$OUT_SO" libqemu_full.so
          echo "=== é¸¿è’™ç‰ˆ UTM äº§ç‰© ==="
          ls -lh libqemu_full.so
          file libqemu_full.so || true
        else
          echo "::warning::No qemu-system-* binaries were produced; please inspect meson-logs/meson-log.txt."
        fi

    - name: OKå•Šä¸Šä¼ äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: qemu-hmos-utm-multiarch
        path: |
          third_party/qemu/build/qemu-system-aarch64
          third_party/qemu/build/qemu-system-x86_64
          third_party/qemu/build/qemu-system-i386
          third_party/qemu/build/libqemu_full.so
        if-no-files-found: ignore