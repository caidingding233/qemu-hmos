name: Build QEMU for Huawei's toolchain (Robust)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake curl wget unzip python3 \
                              libglib2.0-dev libpixman-1-dev libssl-dev \
                              libcurl4-openssl-dev libssh-dev libgnutls28-dev \
                              libsasl2-dev libpam0g-dev libbz2-dev libzstd-dev \
                              libpcre2-dev pkg-config meson tree \
                              binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu

    - name: Download and setup SDK
      run: |
        echo "=== Downloading SDK ==="
        # Try multiple SDK URLs
        SDK_URLS=(
          "https://repo.huaweicloud.com/openharmony/os/5.1.0-Release/ohos-sdk-windows_linux-public.tar.gz"
          "https://repo.huaweicloud.com/openharmony/os/5.0.0-Release/ohos-sdk-windows_linux-public.tar.gz"
          "https://repo.huaweicloud.com/openharmony/os/4.1.0-Release/ohos-sdk-windows_linux-public.tar.gz"
        )
        
        SDK_DOWNLOADED=false
        for url in "${SDK_URLS[@]}"; do
          echo "Trying SDK URL: $url"
          if curl -L -o ohos-sdk.tar.gz "$url"; then
            echo "✅ SDK downloaded successfully from: $url"
            SDK_DOWNLOADED=true
            break
          else
            echo "❌ Failed to download from: $url"
          fi
        done
        
        if [ "$SDK_DOWNLOADED" = false ]; then
          echo "❌ All SDK download attempts failed"
          exit 1
        fi
        
        echo "=== Extracting SDK ==="
        tar -xzf ohos-sdk.tar.gz
        rm ohos-sdk.tar.gz
        rm -rf ohos-sdk/{ohos,windows}
        
        echo "=== Analyzing SDK structure ==="
        echo "Root SDK structure:"
        ls -la ohos-sdk/
        
        echo ""
        echo "Linux SDK structure:"
        ls -la ohos-sdk/linux/
        
        echo ""
        echo "All files in linux directory:"
        find ohos-sdk/linux -type f | head -20

    - name: Find and extract native SDK
      run: |
        echo "=== Finding native SDK ==="
        cd ohos-sdk/linux
        
        # Look for any zip files that might contain native tools
        echo "Looking for zip files:"
        find . -name "*.zip" -type f
        
        # Try different patterns for native SDK
        NATIVE_PATTERNS=(
          "native-linux-x64-*.zip"
          "native-*.zip"
          "*native*.zip"
          "*-native-*.zip"
        )
        
        NATIVE_ZIP=""
        for pattern in "${NATIVE_PATTERNS[@]}"; do
          echo "Searching for pattern: $pattern"
          found=$(find . -name "$pattern" -type f | head -1)
          if [ -n "$found" ]; then
            NATIVE_ZIP="$found"
            echo "✅ Found native SDK: $NATIVE_ZIP"
            break
          fi
        done
        
        if [ -z "$NATIVE_ZIP" ]; then
          echo "❌ No native SDK zip found"
          echo "Available files:"
          find . -type f | head -20
          echo ""
          echo "Trying to find any clang compiler directly:"
          find . -name "*clang*" -type f | head -10
          exit 1
        fi
        
        echo "=== Extracting native SDK ==="
        echo "Extracting: $NATIVE_ZIP"
        unzip -q "$NATIVE_ZIP"
        rm "$NATIVE_ZIP"
        
        echo "=== Analyzing extracted content ==="
        echo "Contents after extraction:"
        ls -la
        
        # Look for the extracted directory with multiple patterns
        echo ""
        echo "=== Looking for native directory ==="
        NATIVE_DIR=""
        
        # Try different patterns
        for pattern in "native-linux-x64-*" "native-*" "*native*"; do
          echo "Searching for pattern: $pattern"
          found=$(find . -name "$pattern" -type d | head -1)
          if [ -n "$found" ]; then
            NATIVE_DIR="$found"
            echo "✅ Found with pattern '$pattern': $NATIVE_DIR"
            break
          fi
        done
        
        # If still not found, try generic 'native' directory
        if [ -z "$NATIVE_DIR" ]; then
          echo "Trying generic 'native' directory search..."
          NATIVE_DIR=$(find . -type d -name 'native' | head -1)
          if [ -n "$NATIVE_DIR" ]; then
            echo "✅ Found generic native directory: $NATIVE_DIR"
          fi
        fi
        
        if [ -z "$NATIVE_DIR" ]; then
          echo "❌ No native directory found after extraction"
          echo "Available directories:"
          find . -type d | head -20
          echo ""
          echo "Available files:"
          find . -type f | head -20
          exit 1
        fi
        
        echo "✅ Final native directory: $NATIVE_DIR"

        echo "=== Analyzing native directory ==="
        echo "Contents of $NATIVE_DIR:"
        ls -la "$NATIVE_DIR"

        # Persist native directory path for later steps
        echo "NATIVE_DIR=$NATIVE_DIR" >> $GITHUB_ENV
        
        echo ""
        echo "Looking for llvm directory:"
        find "$NATIVE_DIR" -name "llvm" -type d
        
        echo ""
        echo "Looking for build-tools directory:"
        find "$NATIVE_DIR" -name "build-tools" -type d
        
        echo ""
        echo "Looking for any clang compiler:"
        find "$NATIVE_DIR" -name "*clang*" -type f

    - name: Setup environment and test
      run: |
        echo "=== Setting up environment ==="
        cd ohos-sdk/linux
        
        # Set up paths based on what we found
        export OHOS_NDK_HOME="$(pwd)/$NATIVE_DIR"
        export SYSROOT="$(pwd)/$NATIVE_DIR/sysroot"
        
        # Try to find clang compiler
        CLANG_CANDIDATES=(
          "$(pwd)/$NATIVE_DIR/llvm/bin/aarch64-unknown-linux-ohos-clang"
          "$(pwd)/$NATIVE_DIR/llvm/bin/clang"
          "$(pwd)/$NATIVE_DIR/bin/aarch64-unknown-linux-ohos-clang"
          "$(pwd)/$NATIVE_DIR/bin/clang"
        )
        
        CC=""
        for candidate in "${CLANG_CANDIDATES[@]}"; do
          if [ -f "$candidate" ]; then
            CC="$candidate"
            echo "✅ Found CC: $CC"
            break
          fi
        done
        
        if [ -z "$CC" ]; then
          echo "❌ No clang compiler found"
          echo "Available files in native directory:"
          find "$NATIVE_DIR" -type f | head -20
          LLVM_BIN_DIR="$(pwd)/$NATIVE_DIR/llvm/bin"
          if [ -d "$LLVM_BIN_DIR" ]; then
            echo ""
            echo "Attempting fallback discovery in $LLVM_BIN_DIR"
            CLANG_AUTO=$(find "$LLVM_BIN_DIR" -maxdepth 1 -name "clang*" -type f | head -1)
            if [ -n "$CLANG_AUTO" ]; then
              echo "✅ Auto-detected CC candidate: $CLANG_AUTO"
              CC="$CLANG_AUTO"
            fi
          fi
        fi

        if [ -z "$CC" ]; then
          echo "❌ Still no clang compiler found"
          exit 1
        fi
        
        # Try to find C++ compiler
        CXX_CANDIDATES=(
          "$(pwd)/$NATIVE_DIR/llvm/bin/aarch64-unknown-linux-ohos-clang++"
          "$(pwd)/$NATIVE_DIR/llvm/bin/clang++"
          "$(pwd)/$NATIVE_DIR/bin/aarch64-unknown-linux-ohos-clang++"
          "$(pwd)/$NATIVE_DIR/bin/clang++"
        )
        
        CXX=""
        for candidate in "${CXX_CANDIDATES[@]}"; do
          if [ -f "$candidate" ]; then
            CXX="$candidate"
            echo "✅ Found CXX: $CXX"
            break
          fi
        done
        
        if [ -z "$CXX" ]; then
          echo "⚠️ No C++ compiler found, using CC for CXX"
          LLVM_BIN_DIR="$(pwd)/$NATIVE_DIR/llvm/bin"
          if [ -d "$LLVM_BIN_DIR" ]; then
            CLANGXX_AUTO=$(find "$LLVM_BIN_DIR" -maxdepth 1 -name "clang++*" -type f | head -1)
            if [ -n "$CLANGXX_AUTO" ]; then
              echo "✅ Auto-detected clang++ candidate: $CLANGXX_AUTO"
              CXX="$CLANGXX_AUTO"
            fi
          fi
        fi

        if [ -z "$CXX" ]; then
          echo "⚠️ Falling back to CC for CXX"
          CXX="$CC"
        fi
        
        # Try to find CMake
        CMAKE_CANDIDATES=(
          "$(pwd)/$NATIVE_DIR/build-tools/cmake/bin/cmake"
          "$(pwd)/$NATIVE_DIR/cmake/bin/cmake"
          "$(pwd)/$NATIVE_DIR/bin/cmake"
          "/usr/bin/cmake"
        )
        
        CMAKE=""
        for candidate in "${CMAKE_CANDIDATES[@]}"; do
          if [ -f "$candidate" ]; then
            CMAKE="$candidate"
            echo "✅ Found CMake: $CMAKE"
            break
          fi
        done
        
        if [ -z "$CMAKE" ]; then
          echo "❌ No CMake found"
          exit 1
        fi
        
        echo "=== Final environment ==="
        echo "OHOS_NDK_HOME: $OHOS_NDK_HOME"
        echo "SYSROOT: $SYSROOT"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "CMAKE: $CMAKE"
        
        echo ""
        echo "=== Testing tools ==="
        echo "Testing CC:"
        file "$CC"
        "$CC" --version 2>&1 | head -3 || echo "CC version check failed"
        
        echo ""
        echo "Testing CMake:"
        "$CMAKE" --version | head -3 || echo "CMake version check failed"
        
        # Save environment for next steps
        echo "OHOS_NDK_HOME=$OHOS_NDK_HOME" >> $GITHUB_ENV
        echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "CMAKE=$CMAKE" >> $GITHUB_ENV

    - name: Build QEMU
      run: |
        echo "=== Restoring environment variables ==="
        # Restore environment variables from previous step
        export OHOS_NDK_HOME="$OHOS_NDK_HOME"
        export SYSROOT="$SYSROOT"
        export CC="$CC"
        export CXX="$CXX"
        export CMAKE="$CMAKE"

        echo "=== Building QEMU ==="
        cd third_party/qemu

        mkdir -p build
        cd build

        echo "Environment check:"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "SYSROOT: $SYSROOT"
        
        echo ""
        echo "=== Running Configure ==="
        ../configure \
          --target-list=aarch64-softmmu \
          --cc="$CC" \
          --cxx="$CXX" \
          --host-cc="/usr/bin/cc" \
          --cross-prefix="" \
          --extra-cflags="--target=aarch64-linux-gnu --sysroot=${SYSROOT} -I/usr/include" \
          --extra-cxxflags="--target=aarch64-linux-gnu --sysroot=${SYSROOT} -I/usr/include" \
          --extra-ldflags="--target=aarch64-linux-gnu --sysroot=${SYSROOT}" \
          -Db_staticpic=true \
          -Db_pie=false \
          -Ddefault_library=static \
          -Dtools=disabled \
          --enable-tcg \
          --disable-kvm \
          --disable-xen \
          --disable-werror \
          --enable-vnc \
          --enable-slirp \
          --enable-curl \
          --enable-fdt \
          --enable-guest-agent \
          --enable-vhost-user \
          --enable-vhost-net \
          --enable-keyring \
          --disable-gtk \
          --disable-sdl \
          --disable-vte \
          --disable-curses \
          --disable-brlapi \
          --disable-spice \
          --disable-usb-redir \
          --disable-lzo \
          --disable-snappy \
          --disable-bzip2 \
          --disable-lzfse \
          --disable-zstd \
          --disable-libssh \
          --disable-nettle \
          --disable-gcrypt \
          --enable-gnutls
        
        echo "✅ Configure completed!"
        
        echo "=== Building QEMU ==="
        # 设置正确的链接器环境变量
        export LD=aarch64-linux-gnu-ld
        export AR=aarch64-linux-gnu-ar
        export RANLIB=aarch64-linux-gnu-ranlib
        export STRIP=aarch64-linux-gnu-strip
        make -j$(nproc)
        
        echo "✅ QEMU build completed!"
        
        echo "=== Checking build results ==="
        ls -la qemu-system-aarch64 || echo "Main binary not found"
        find . -name "*.so" -o -name "*.a" | head -10

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qemu-harmonyos-build
        path: |
          third_party/qemu/build/qemu-system-aarch64
          third_party/qemu/build/*.so
          third_party/qemu/build/*.a
        retention-days: 7
