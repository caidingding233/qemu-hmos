/**
 * VNC ç‹¬ç«‹çª—å£é¡µé¢
 * åœ¨æ–°çª—å£ä¸­æ˜¾ç¤º VNC è¿œç¨‹æ¡Œé¢
 */
import common from '@ohos.app.ability.common'
import hilog from '@ohos.hilog'
import { VNCDisplay } from '../components/VNCDisplay'

@Entry
@Component
struct VNCWindow {
  @StorageLink('vnc_vmName') vmName: string = 'VM'
  @StorageLink('vnc_port') vncPort: number = 5701  // WebSocket ç«¯å£
  @StorageLink('vnc_host') vncHost: string = '127.0.0.1'
  
  @State isConnected: boolean = false
  @State statusText: string = 'æ­£åœ¨è¿žæŽ¥...'
  
  aboutToAppear(): void {
    hilog.info(0x0000, 'VNCWindow', 'é¡µé¢åŠ è½½: vm=%{public}s host=%{public}s:%{public}d',
      this.vmName, this.vncHost, this.vncPort)
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      Row() {
        // VM åç§°
        Text(`ðŸ–¥ï¸ ${this.vmName}`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
        
        Blank()
        
        // è¿žæŽ¥çŠ¶æ€
        Row() {
          Circle()
            .width(8)
            .height(8)
            .fill(this.isConnected ? '#34C759' : '#FF9500')
          Text(this.statusText)
            .fontSize(12)
            .fontColor('#AAAAAA')
            .margin({ left: 6 })
        }
        
        // å…³é—­æŒ‰é’®
        Button() {
          Text('âœ•').fontSize(16).fontColor('#888888')
        }
        .type(ButtonType.Circle)
        .width(32)
        .height(32)
        .backgroundColor('rgba(255, 255, 255, 0.1)')
        .margin({ left: 16 })
        .onClick(() => {
          this.closeWindow()
        })
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('rgba(30, 30, 30, 0.95)')
      
      // VNC æ˜¾ç¤ºåŒºåŸŸ
      VNCDisplay({
        config: { host: this.vncHost, port: this.vncPort },
        callbacks: {
          onConnected: () => {
            this.isConnected = true
            this.statusText = 'å·²è¿žæŽ¥'
          },
          onDisconnected: () => {
            this.isConnected = false
            this.statusText = 'å·²æ–­å¼€'
          },
          onError: (error: string) => {
            this.statusText = `é”™è¯¯: ${error}`
          }
        }
      })
      .layoutWeight(1)
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A1A')
  }
  
  private closeWindow(): void {
    const ctx = getContext(this) as common.UIAbilityContext
    ctx.terminateSelf()
  }
}

