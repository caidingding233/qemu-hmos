/**
 * RDP ç‹¬ç«‹çª—å£é¡µé¢
 * åœ¨æ–°çª—å£ä¸­æ˜¾ç¤º FreeRDP è¿œç¨‹æ¡Œé¢
 */
import common from '@ohos.app.ability.common'
import hilog from '@ohos.hilog'
import qemu from 'qemu_hmos'

interface RdpClientInfo {
  id: string
}

interface RdpConnectConfig {
  host: string
  port: number
  username?: string
  password?: string
  width?: number
  height?: number
}

interface RdpNativeApi {
  createRdpClient?: () => RdpClientInfo
  connectRdp?: (clientId: string, config: RdpConnectConfig) => number
  getRdpStatus?: (clientId: string) => number
  disconnectRdp?: (clientId: string) => number
  destroyRdpClient?: (clientId: string) => number
}

@Entry
@Component
struct RDPWindow {
  @StorageLink('rdp_vmName') vmName: string = 'VM'
  @StorageLink('rdp_vmId') vmId: string = ''
  @StorageLink('rdp_port') rdpPort: number = 3390
  @StorageLink('rdp_host') rdpHost: string = '127.0.0.1'
  
  @State isConnected: boolean = false
  @State statusText: string = 'æ­£åœ¨è¿æ¥...'
  @State connectionInfo: string = ''
  private rdpClientId: string = ''
  
  aboutToAppear(): void {
    hilog.info(0x0000, 'RDPWindow', 'é¡µé¢åŠ è½½: vm=%{public}s host=%{public}s:%{public}d',
      this.vmName, this.rdpHost, this.rdpPort)
    
    this.connectionInfo = `${this.rdpHost}:${this.rdpPort}`
    
    this.connectRDP()
  }
  
  private connectRDP(): void {
    try {
      this.statusText = 'æ­£åœ¨å‘èµ· FreeRDP è¿æ¥...'
      
      if (!qemu || typeof qemu.createRdpClient !== 'function' || typeof qemu.connectRdp !== 'function') {
        this.isConnected = false
        this.statusText = 'FreeRDP æ¨¡å—ä¸å¯ç”¨'
        hilog.error(0x0000, 'RDPWindow', 'qemu_hmos RDP æ¥å£ä¸å¯ç”¨')
        return
      }
      
      const client = qemu.createRdpClient()
      this.rdpClientId = client?.id ?? ''
      if (!this.rdpClientId) {
        this.isConnected = false
        this.statusText = 'åˆ›å»º RDP å®¢æˆ·ç«¯å¤±è´¥'
        return
      }
      
      const result = qemu.connectRdp(this.rdpClientId, {
        host: this.rdpHost,
        port: this.rdpPort,
        username: '',
        password: '',
        width: 1280,
        height: 720
      })
      
      if (result === 0) {
        this.isConnected = true
        this.statusText = 'å·²è¿æ¥ FreeRDP'
        hilog.info(0x0000, 'RDPWindow', 'FreeRDP è¿æ¥æˆåŠŸ: %{public}s', this.connectionInfo)
      } else {
        this.isConnected = false
        this.statusText = 'FreeRDP è¿æ¥å¤±è´¥'
        hilog.error(0x0000, 'RDPWindow', 'FreeRDP è¿æ¥å¤±è´¥ï¼ŒçŠ¶æ€ç  %{public}d', result)
      }
    } catch (e) {
      const message = (e as Error).message ?? String(e)
      this.isConnected = false
      this.statusText = `é”™è¯¯: ${message}`
      hilog.error(0x0000, 'RDPWindow', 'FreeRDP å¯åŠ¨å¤±è´¥: %{public}s', message)
    }
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      Row() {
        // VM åç§°
        Text(`ğŸš€ ${this.vmName}`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
        
        Blank()
        
        // è¿æ¥ä¿¡æ¯
        Text(this.connectionInfo)
          .fontSize(12)
          .fontColor('#666666')
          .margin({ right: 12 })
        
        // è¿æ¥çŠ¶æ€
        Row() {
          Circle()
            .width(8)
            .height(8)
            .fill(this.isConnected ? '#34C759' : '#FF9500')
          Text(this.statusText)
            .fontSize(12)
            .fontColor('#AAAAAA')
            .margin({ left: 6 })
        }
        
        // å…³é—­æŒ‰é’®
        Button() {
          Text('âœ•').fontSize(16).fontColor('#888888')
        }
        .type(ButtonType.Circle)
        .width(32)
        .height(32)
        .backgroundColor('rgba(255, 255, 255, 0.1)')
        .margin({ left: 16 })
        .onClick(() => {
          this.closeWindow()
        })
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('rgba(30, 30, 30, 0.95)')
      
      // RDP æ˜¾ç¤ºåŒºåŸŸï¼ˆå ä½ï¼‰
      Column() {
        // åŠ è½½åŠ¨ç”»
        if (!this.isConnected) {
          Column() {
            LoadingProgress()
              .width(64)
              .height(64)
              .color('#007AFF')
            
            Text('æ­£åœ¨è¿æ¥ RDP æœåŠ¡...')
              .fontSize(16)
              .fontColor('#888888')
              .margin({ top: 16 })
            
            Text(`ç›®æ ‡: ${this.rdpHost}:${this.rdpPort}`)
              .fontSize(13)
              .fontColor('#555555')
              .margin({ top: 8 })
            
            // æç¤ºä¿¡æ¯
            Column() {
              Text('ğŸ’¡ æç¤º')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FF9500')
                .margin({ bottom: 8 })
              
              Text('â€¢ ç¡®ä¿è™šæ‹Ÿæœºå†…å·²å¯ç”¨è¿œç¨‹æ¡Œé¢')
                .fontSize(12)
                .fontColor('#666666')
              Text('â€¢ Windows: è®¾ç½® â†’ ç³»ç»Ÿ â†’ è¿œç¨‹æ¡Œé¢')
                .fontSize(12)
                .fontColor('#666666')
              Text('â€¢ Linux: å®‰è£… xrdp æœåŠ¡')
                .fontSize(12)
                .fontColor('#666666')
            }
            .margin({ top: 32 })
            .padding(16)
            .backgroundColor('rgba(255, 149, 0, 0.1)')
            .borderRadius(12)
          }
          .justifyContent(FlexAlign.Center)
          .width('100%')
          .height('100%')
        }
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#0D0D0D')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A1A')
  }
  
  private closeWindow(): void {
    if (this.rdpClientId && qemu && typeof qemu.disconnectRdp === 'function') {
      try {
        qemu.disconnectRdp(this.rdpClientId)
      } catch (e) {
        hilog.warn(0x0000, 'RDPWindow', 'æ–­å¼€ FreeRDP æ—¶å‡ºé”™: %{public}s', (e as Error).message)
      }
    }
    const ctx = getContext(this) as common.UIAbilityContext
    ctx.terminateSelf()
  }
}

