/**
 * ä¸²å£æ§åˆ¶å° ç‹¬ç«‹çª—å£é¡µé¢
 * åœ¨æ–°çª—å£ä¸­æ˜¾ç¤ºè™šæ‹Ÿæœºçš„ä¸²å£ TTL ç»ˆç«¯
 */
import common from '@ohos.app.ability.common'
import hilog from '@ohos.hilog'
import { QemuVMManager } from '../managers/QemuVMManager'

@Entry
@Component
struct ConsoleWindow {
  @StorageLink('console_vmName') vmName: string = 'VM'
  @StorageLink('console_vmId') vmId: string = ''
  
  @State consoleOutput: string[] = []
  @State inputText: string = ''
  @State isConnected: boolean = true
  
  private scrollerRef: Scroller = new Scroller()
  private maxLines: number = 1000
  
  aboutToAppear(): void {
    hilog.info(0x0000, 'ConsoleWindow', 'é¡µé¢åŠ è½½: vmName=%{public}s vmId=%{public}s', this.vmName, this.vmId)
    
    // æ³¨å†Œæ§åˆ¶å°è¾“å‡ºå›è°ƒ
    this.setupConsoleCallback()
    
    // æ·»åŠ æ¬¢è¿ä¿¡æ¯
    this.appendOutput(`\x1b[32mâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\x1b[0m`)
    this.appendOutput(`\x1b[32mâ”‚\x1b[0m  QEMU Serial Console - ${this.vmName}`)
    this.appendOutput(`\x1b[32mâ”‚\x1b[0m  Type commands and press Enter to send`)
    this.appendOutput(`\x1b[32mâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\x1b[0m`)
    this.appendOutput('')
  }
  
  private setupConsoleCallback(): void {
    try {
      QemuVMManager.getInstance().setConsoleCallback((data: string) => {
        this.appendOutput(data)
      })
    } catch (e) {
      hilog.error(0x0000, 'ConsoleWindow', 'è®¾ç½®æ§åˆ¶å°å›è°ƒå¤±è´¥: %{public}s', (e as Error).message)
    }
  }
  
  private appendOutput(text: string): void {
    // æŒ‰è¡Œåˆ†å‰²
    const lines = text.split('\n')
    for (const line of lines) {
      this.consoleOutput.push(line)
    }
    
    // é™åˆ¶æœ€å¤§è¡Œæ•°
    if (this.consoleOutput.length > this.maxLines) {
      this.consoleOutput = this.consoleOutput.slice(-this.maxLines)
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
      this.scrollerRef.scrollEdge(Edge.Bottom)
    }, 50)
  }
  
  private sendCommand(): void {
    if (!this.inputText.trim()) return
    
    const cmd = this.inputText
    this.inputText = ''
    
    // æ˜¾ç¤ºè¾“å…¥çš„å‘½ä»¤
    this.appendOutput(`\x1b[36m> ${cmd}\x1b[0m`)
    
    // å‘é€åˆ° QEMU
    try {
      QemuVMManager.getInstance().writeToVmConsole(cmd + '\n')
    } catch (e) {
      this.appendOutput(`\x1b[31m[é”™è¯¯] å‘é€å¤±è´¥: ${(e as Error).message}\x1b[0m`)
    }
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      Row() {
        // VM åç§°
        Text(`ğŸ”§ ${this.vmName} - ä¸²å£æ§åˆ¶å°`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
        
        Blank()
        
        // è¿æ¥çŠ¶æ€
        Row() {
          Circle()
            .width(8)
            .height(8)
            .fill(this.isConnected ? '#34C759' : '#FF3B30')
          Text(this.isConnected ? 'TTY' : 'æ–­å¼€')
            .fontSize(12)
            .fontColor('#AAAAAA')
            .margin({ left: 6 })
        }
        
        // æ¸…å±æŒ‰é’®
        Button() {
          Text('ğŸ—‘ï¸').fontSize(14)
        }
        .type(ButtonType.Circle)
        .width(32)
        .height(32)
        .backgroundColor('rgba(255, 255, 255, 0.1)')
        .margin({ left: 12 })
        .onClick(() => {
          this.consoleOutput = []
        })
        
        // å…³é—­æŒ‰é’®
        Button() {
          Text('âœ•').fontSize(16).fontColor('#888888')
        }
        .type(ButtonType.Circle)
        .width(32)
        .height(32)
        .backgroundColor('rgba(255, 255, 255, 0.1)')
        .margin({ left: 8 })
        .onClick(() => {
          this.closeWindow()
        })
      }
      .width('100%')
      .height(48)
      .padding({ left: 16, right: 16 })
      .backgroundColor('rgba(30, 30, 30, 0.95)')
      
      // æ§åˆ¶å°è¾“å‡ºåŒºåŸŸ
      Scroll(this.scrollerRef) {
        Column() {
          ForEach(this.consoleOutput, (line: string, index: number) => {
            Text(this.parseAnsiColors(line))
              .fontSize(13)
              .fontFamily('monospace')
              .fontColor('#00FF00')
              .width('100%')
              .textAlign(TextAlign.Start)
          })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
        .padding(12)
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#0D0D0D')
      .scrollBar(BarState.Auto)
      
      // è¾“å…¥åŒºåŸŸ
      Row() {
        Text('>')
          .fontSize(14)
          .fontFamily('monospace')
          .fontColor('#00FF00')
          .margin({ right: 8 })
        
        TextInput({ text: this.inputText, placeholder: 'è¾“å…¥å‘½ä»¤...' })
          .layoutWeight(1)
          .height(40)
          .fontSize(14)
          .fontFamily('monospace')
          .fontColor('#00FF00')
          .placeholderColor('#336633')
          .backgroundColor('rgba(0, 255, 0, 0.05)')
          .borderRadius(8)
          .caretColor('#00FF00')
          .onChange((val: string) => {
            this.inputText = val
          })
          .onSubmit(() => {
            this.sendCommand()
          })
        
        Button('å‘é€')
          .type(ButtonType.Capsule)
          .height(36)
          .fontSize(13)
          .backgroundColor('#007AFF')
          .margin({ left: 12 })
          .onClick(() => {
            this.sendCommand()
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })
      .backgroundColor('rgba(30, 30, 30, 0.95)')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#0D0D0D')
  }
  
  // ç®€å•çš„ ANSI é¢œè‰²è§£æï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œå®é™…é¢œè‰²é€šè¿‡æ ·å¼æ§åˆ¶ï¼‰
  private parseAnsiColors(text: string): string {
    // ç§»é™¤ ANSI è½¬ä¹‰åºåˆ—ï¼Œä¿ç•™çº¯æ–‡æœ¬
    return text.replace(/\x1b\[[0-9;]*m/g, '')
  }
  
  private closeWindow(): void {
    const ctx = getContext(this) as common.UIAbilityContext
    ctx.terminateSelf()
  }
}

