/**
 * RDP è¿æ¥è¶…æ—¶å¤„ç†å¯¹è¯æ¡†
 * 
 * å½“ RDP è¿æ¥è¶…æ—¶æˆ–å¡æ­»æ—¶ï¼Œæ˜¾ç¤ºæ­¤å¯¹è¯æ¡†
 * å¼•å¯¼ç”¨æˆ·é€‰æ‹©ï¼šç»§ç»­ç­‰å¾…ã€å–æ¶ˆè¿æ¥ã€å¼ºåˆ¶å…³é—­
 */

import { rdpManager, RdpConnectionInfo, SuggestedAction } from '../utils/RdpConnectionManager'

@CustomDialog
export struct RdpTimeoutDialog {
  controller: CustomDialogController
  @State connectionInfo: RdpConnectionInfo = {
    status: 'timeout',
    timeoutSeconds: 0,
    isStuck: true,
    message: 'è¿æ¥è¶…æ—¶'
  }
  onAction?: (action: 'wait' | 'cancel' | 'force' | 'disconnect') => void

  aboutToAppear() {
    // è·å–æœ€æ–°çŠ¶æ€
    this.connectionInfo = rdpManager.getStatus()
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('âš ï¸')
          .fontSize(24)
          .margin({ right: 8 })
        Text('è¿æ¥é—®é¢˜')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ bottom: 16 })

      // çŠ¶æ€ä¿¡æ¯
      Column() {
        Text(this.connectionInfo.message)
          .fontSize(16)
          .fontColor('#666666')
          .textAlign(TextAlign.Center)
        
        if (this.connectionInfo.timeoutSeconds > 0) {
          Text(`å·²ç­‰å¾… ${this.connectionInfo.timeoutSeconds} ç§’`)
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 8 })
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFF9E6')
      .borderRadius(8)
      .margin({ bottom: 20 })

      // è¯´æ˜æ–‡å­—
      Text('è¯·é€‰æ‹©æ“ä½œï¼š')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .margin({ bottom: 12 })

      // æ“ä½œæŒ‰é’®
      Column({ space: 10 }) {
        // ç»§ç»­ç­‰å¾…
        Button('ç»§ç»­ç­‰å¾…')
          .width('100%')
          .height(44)
          .backgroundColor('#E8F5E9')
          .fontColor('#2E7D32')
          .onClick(() => {
            if (this.onAction) {
              this.onAction('wait')
            }
            this.controller.close()
          })

        // å–æ¶ˆè¿æ¥
        Button('å–æ¶ˆè¿æ¥')
          .width('100%')
          .height(44)
          .backgroundColor('#E3F2FD')
          .fontColor('#1976D2')
          .onClick(() => {
            rdpManager.requestCancel()
            if (this.onAction) {
              this.onAction('cancel')
            }
            this.controller.close()
          })

        // å¼ºåˆ¶å…³é—­ï¼ˆå±é™©æ“ä½œï¼‰
        Button('å¼ºåˆ¶å…³é—­')
          .width('100%')
          .height(44)
          .backgroundColor('#FFEBEE')
          .fontColor('#C62828')
          .onClick(() => {
            rdpManager.forceCleanup()
            if (this.onAction) {
              this.onAction('force')
            }
            this.controller.close()
          })
      }
      .width('100%')

      // æç¤ºä¿¡æ¯
      Text('ğŸ’¡ å¦‚æœè¿æ¥ä¸€ç›´å¡ä½ï¼Œè¯·é€‰æ‹©"å¼ºåˆ¶å…³é—­"')
        .fontSize(12)
        .fontColor('#999999')
        .margin({ top: 16 })
    }
    .width('90%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

/**
 * æ˜¾ç¤º RDP è¶…æ—¶å¯¹è¯æ¡†çš„å·¥å…·å‡½æ•°
 */
export function showRdpTimeoutDialog(
  context: UIContext, 
  onAction?: (action: 'wait' | 'cancel' | 'force' | 'disconnect') => void
): CustomDialogController {
  let dialogController: CustomDialogController = new CustomDialogController({
    builder: RdpTimeoutDialog({
      onAction: onAction
    }),
    autoCancel: false,  // ä¸å…è®¸ç‚¹å‡»å¤–éƒ¨å…³é—­
    alignment: DialogAlignment.Center,
    customStyle: true
  })
  
  dialogController.open()
  return dialogController
}
